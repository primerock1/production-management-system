# Архитектура системы управления производством

## Общий обзор

Система построена по трехуровневой архитектуре:
- **Presentation Layer** (Frontend) - веб-интерфейс
- **Business Logic Layer** (Backend API) - бизнес-логика
- **Data Access Layer** (Database) - хранение данных

```
┌─────────────────────────────────────────────────────────────┐
│                    FRONTEND (Port 3000)                    │
│  HTML5 + CSS3 + JavaScript + Bootstrap + Font Awesome     │
├─────────────────────────────────────────────────────────────┤
│                 HTTP/JSON API Calls                        │
├─────────────────────────────────────────────────────────────┤
│                    BACKEND (Port 8000)                     │
│         FastAPI + SQLAlchemy + Pydantic + Uvicorn         │
├─────────────────────────────────────────────────────────────┤
│                   SQLAlchemy ORM                           │
├─────────────────────────────────────────────────────────────┤
│                  DATABASE (SQLite)                         │
│              production_db.sqlite (172 records)            │
└─────────────────────────────────────────────────────────────┘
```

## Структура проекта

```
production-management-system/
├── backend/                          # Backend API (FastAPI)
│   ├── app/
│   │   ├── models/                   # SQLAlchemy модели данных
│   │   │   ├── __init__.py
│   │   │   ├── material_type.py      # Модель типов материалов
│   │   │   ├── product_type.py       # Модель типов продукции
│   │   │   ├── workshop.py           # Модель цехов
│   │   │   ├── product.py            # Модель продукции
│   │   │   └── product_workshop.py   # Модель связей
│   │   ├── schemas/                  # Pydantic схемы валидации
│   │   │   ├── __init__.py
│   │   │   ├── material_type.py      # Схемы для типов материалов
│   │   │   ├── product_type.py       # Схемы для типов продукции
│   │   │   ├── workshop.py           # Схемы для цехов
│   │   │   ├── product.py            # Схемы для продукции
│   │   │   └── product_workshop.py   # Схемы для связей
│   │   ├── routers/                  # API роутеры (контроллеры)
│   │   │   ├── __init__.py
│   │   │   ├── material_type.py      # CRUD для типов материалов
│   │   │   ├── product_type.py       # CRUD для типов продукции
│   │   │   ├── workshop.py           # CRUD для цехов
│   │   │   ├── product.py            # CRUD для продукции
│   │   │   ├── product_workshop.py   # CRUD для связей
│   │   │   └── material_calculator.py # Калькулятор сырья
│   │   ├── services/                 # Бизнес-логика
│   │   │   ├── __init__.py
│   │   │   └── material_calculator.py # Сервис расчета сырья
│   │   ├── config.py                 # Конфигурация приложения
│   │   ├── database.py               # Подключение к БД
│   │   ├── main.py                   # Главный файл FastAPI
│   │   └── __init__.py
│   ├── requirements.txt              # Зависимости Python
│   └── run.py                        # Скрипт запуска сервера
├── frontend/                         # Frontend (HTML/CSS/JS)
│   ├── css/
│   │   └── style.css                 # Стили приложения
│   ├── js/
│   │   ├── api.js                    # HTTP клиент для API
│   │   ├── modals.js                 # Модальные окна
│   │   └── app.js                    # Основная логика
│   ├── index.html                    # Главная страница
│   └── logo.png                      # Корпоративный логотип
├── Resources/                        # Исходные данные
│   └── xlsx/                         # Excel файлы для импорта
│       ├── Material_type_import.xlsx
│       ├── Product_type_import.xlsx
│       ├── Workshops_import.xlsx
│       ├── Products_import.xlsx
│       └── Product_workshops_import.xlsx
├── Отчёты/                          # Документация проекта
│   ├── Отчет по заданию 1_ База данных.pdf
│   ├── Отчет по заданию 2_ Бэкенд.pdf
│   ├── Отчет по заданию 3_ Фронтенд.html
│   ├── Отчет по заданию 4_ Дополнительный функционал.html
│   └── Итоговый отчет по проекту.html
├── Пояснения/                       # Техническая документация
│   ├── ПОЯСНЕНИЯ_ПО_БД_СКРИПТАМ.md
│   ├── ПОЯСНЕНИЯ_ПО_КОДУ.md
│   ├── ПОЯСНЕНИЯ_ПО_ФРОНТЕНДУ.md
│   ├── ПОЯСНЕНИЯ_ПО_КАЛЬКУЛЯТОРУ.md
│   └── АРХИТЕКТУРА_СИСТЕМЫ.md
├── production_db.sqlite             # База данных SQLite
├── ER_diagram.pdf                   # ER-диаграмма БД
├── create_database.py               # Скрипт создания БД
├── create_er_diagram.py             # Скрипт создания диаграммы
├── start_system.bat                 # Автозапуск системы
├── requirements.txt                 # Зависимости проекта
├── .gitignore                       # Исключения Git
└── README.md                        # Руководство пользователя
```

## Архитектурные паттерны

### 1. Model-View-Controller (MVC)

**Model (Модель):**
- `backend/app/models/` - SQLAlchemy модели
- Представляют структуру данных
- Определяют связи между таблицами
- Инкапсулируют бизнес-правила данных

**View (Представление):**
- `frontend/` - HTML/CSS/JavaScript
- Отображает данные пользователю
- Обрабатывает пользовательский ввод
- Адаптивный интерфейс

**Controller (Контроллер):**
- `backend/app/routers/` - FastAPI роутеры
- Обрабатывают HTTP запросы
- Координируют работу моделей и представлений
- Валидируют входные данные

### 2. Repository Pattern

```python
# Пример в роутере
@router.get("/", response_model=List[MaterialTypeResponse])
def get_material_types(
    skip: int = 0,
    limit: int = 100,
    db: Session = Depends(get_db)
):
    material_types = db.query(MaterialType).offset(skip).limit(limit).all()
    return material_types
```

**Преимущества:**
- Абстракция доступа к данным
- Легкость тестирования
- Возможность смены БД

### 3. Dependency Injection

```python
# В main.py
from app.database import get_db

# В роутерах
def create_material_type(
    material_type: MaterialTypeCreate,
    db: Session = Depends(get_db)  # DI контейнер
):
```

**Особенности:**
- FastAPI автоматически внедряет зависимости
- Управление жизненным циклом объектов
- Легкость мокирования для тестов

### 4. Service Layer Pattern

```python
# backend/app/services/material_calculator.py
class MaterialCalculatorService:
    def __init__(self, db: Session):
        self.db = db
    
    def calculate_raw_material(self, ...):
        # Бизнес-логика расчетов
```

**Назначение:**
- Инкапсуляция сложной бизнес-логики
- Переиспользование между контроллерами
- Изоляция от деталей реализации

## Слои архитектуры

### 1. Presentation Layer (Frontend)

**Технологии:**
- HTML5 - семантическая разметка
- CSS3 - стили и анимации
- JavaScript ES6+ - интерактивность
- Bootstrap 5.3 - UI компоненты
- Font Awesome 6.4 - иконки

**Компоненты:**
```javascript
// Модульная архитектура JS
├── api.js          // HTTP клиент
├── modals.js       // UI компоненты
└── app.js          // Основная логика
```

**Паттерны:**
- Module Pattern для организации кода
- Observer Pattern для уведомлений
- Factory Pattern для создания элементов

### 2. API Layer (Backend Controllers)

**Структура роутера:**
```python
from fastapi import APIRouter, Depends, HTTPException
from sqlalchemy.orm import Session

router = APIRouter(prefix="/api/material-types", tags=["material-types"])

@router.get("/")           # READ (список)
@router.get("/{id}")       # READ (по ID)
@router.post("/")          # CREATE
@router.put("/{id}")       # UPDATE
@router.delete("/{id}")    # DELETE
```

**Особенности:**
- RESTful API дизайн
- Автоматическая валидация через Pydantic
- Swagger документация
- CORS поддержка

### 3. Business Logic Layer (Services)

**Пример сервиса:**
```python
class MaterialCalculatorService:
    def calculate_raw_material(self, ...):
        # 1. Валидация входных данных
        # 2. Получение данных из БД
        # 3. Применение бизнес-правил
        # 4. Возврат результата
```

**Принципы:**
- Single Responsibility Principle
- Независимость от внешних систем
- Тестируемость
- Переиспользуемость

### 4. Data Access Layer (Models & Database)

**SQLAlchemy модели:**
```python
class MaterialType(Base):
    __tablename__ = "material_type"
    
    id = Column(Integer, primary_key=True, index=True)
    name = Column(String, unique=True, index=True, nullable=False)
    loss_percentage = Column(Float, nullable=False)
```

**Особенности:**
- ORM для абстракции БД
- Автоматическая генерация SQL
- Миграции схемы
- Связи между таблицами

## Коммуникация между слоями

### 1. Frontend ↔ Backend

**HTTP/JSON API:**
```javascript
// Frontend запрос
const response = await fetch('/api/material-types', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(data)
});

// Backend ответ
{
    "id": 1,
    "name": "Дерево",
    "loss_percentage": 5.0
}
```

**Особенности:**
- RESTful endpoints
- JSON сериализация
- HTTP статус коды
- CORS заголовки

### 2. Backend ↔ Database

**SQLAlchemy ORM:**
```python
# Создание
material_type = MaterialType(name="Дерево", loss_percentage=5.0)
db.add(material_type)
db.commit()

# Чтение
material_types = db.query(MaterialType).all()

# Обновление
material_type.loss_percentage = 6.0
db.commit()

# Удаление
db.delete(material_type)
db.commit()
```

## Безопасность

### 1. Валидация данных

**Pydantic схемы:**
```python
class MaterialTypeCreate(BaseModel):
    name: str = Field(..., min_length=1, max_length=100)
    loss_percentage: float = Field(..., ge=0, le=100)
```

**HTML5 валидация:**
```html
<input type="number" min="0" max="100" step="0.01" required>
```

### 2. SQL Injection защита

**ORM использование:**
```python
# Безопасно - параметризованный запрос
material_type = db.query(MaterialType).filter(MaterialType.id == id).first()

# Небезопасно - прямой SQL (НЕ используется)
# db.execute(f"SELECT * FROM material_type WHERE id = {id}")
```

### 3. CORS настройка

```python
app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],  # В продакшене - конкретные домены
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)
```

## Производительность

### 1. Кэширование на фронтенде

```javascript
let cachedData = {
    materialTypes: null,
    productTypes: null,
    workshops: null,
    products: null
};

async function loadMaterialTypes() {
    if (!cachedData.materialTypes) {
        cachedData.materialTypes = await materialTypesAPI.getAll();
    }
    return cachedData.materialTypes;
}
```

### 2. Пагинация API

```python
@router.get("/")
def get_material_types(
    skip: int = 0,
    limit: int = 100,
    db: Session = Depends(get_db)
):
    return db.query(MaterialType).offset(skip).limit(limit).all()
```

### 3. Индексы БД

```python
class MaterialType(Base):
    id = Column(Integer, primary_key=True, index=True)  # Автоматический индекс
    name = Column(String, unique=True, index=True)      # Индекс для поиска
```

## Масштабируемость

### 1. Модульная архитектура

- Легко добавлять новые сущности
- Независимые модули
- Слабая связанность

### 2. Микросервисная готовность

```python
# Каждый роутер может стать отдельным сервисом
material_service = FastAPI()
material_service.include_router(material_type.router)

product_service = FastAPI()
product_service.include_router(product.router)
```

### 3. Горизонтальное масштабирование

- Stateless API
- Внешняя БД (PostgreSQL/MySQL)
- Load balancer готовность

## Мониторинг и логирование

### 1. Структурированное логирование

```python
import logging

logger = logging.getLogger(__name__)

@router.post("/")
def create_material_type(material_type: MaterialTypeCreate, db: Session = Depends(get_db)):
    logger.info(f"Creating material type: {material_type.name}")
    try:
        # Логика создания
        logger.info(f"Material type created successfully: {result.id}")
        return result
    except Exception as e:
        logger.error(f"Failed to create material type: {e}")
        raise
```

### 2. Health checks

```python
@app.get("/health")
def health_check():
    return {"status": "ok", "timestamp": datetime.now()}
```

### 3. Метрики производительности

- Время ответа API
- Количество запросов
- Ошибки и исключения
- Использование ресурсов

## Тестирование

### 1. Unit тесты

```python
def test_calculate_material():
    calculator = MaterialCalculatorService(mock_db)
    result = calculator.calculate_raw_material(1, 2, 10, 1.5, 2.0)
    assert result > 0
```

### 2. Integration тесты

```python
def test_create_material_type_api():
    response = client.post("/api/material-types", json={
        "name": "Test Material",
        "loss_percentage": 5.0
    })
    assert response.status_code == 200
```

### 3. E2E тесты

- Selenium для UI тестов
- Полный цикл пользовательских сценариев
- Тестирование интеграции компонентов

## Развертывание

### 1. Локальная разработка

```bash
# Автозапуск
start_system.bat

# Ручной запуск
cd backend && python run.py
cd frontend && python -m http.server 3000
```

### 2. Продакшен

```dockerfile
# Dockerfile для backend
FROM python:3.9
COPY requirements.txt .
RUN pip install -r requirements.txt
COPY . .
CMD ["uvicorn", "app.main:app", "--host", "0.0.0.0", "--port", "8000"]
```

```nginx
# Nginx для frontend
server {
    listen 80;
    root /var/www/frontend;
    index index.html;
    
    location /api/ {
        proxy_pass http://backend:8000;
    }
}
```

### 3. CI/CD Pipeline

```yaml
# GitHub Actions
name: Deploy
on: [push]
jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: pytest
  
  deploy:
    needs: test
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to production
        run: docker-compose up -d
```

## Заключение

Архитектура системы обеспечивает:

- **Модульность** - легкость разработки и поддержки
- **Масштабируемость** - возможность роста системы
- **Безопасность** - защита данных и валидация
- **Производительность** - оптимизация запросов и кэширование
- **Тестируемость** - изолированные компоненты
- **Развертываемость** - автоматизация процессов

Система готова к промышленному использованию и может быть легко расширена новым функционалом.